---
nocite: |
 @Gentleman2009R-Programming-Bioinfo, @Grolemund:2016
---

# dataframe（数据框）和tibble {#tibble}

## 查看dataframe/tibble并了解它们的结构 {#tibble-view}

### dataframe/tibble的基本概念 {#tibble-concept}

dataframe是R中存储复杂（多变量）数据的规范格式，它直观易操作。tibble是tidyverse的一部分，它是dataframe的进化版，功能更强大，更易操作。

我们来看个例子：

首先加载tidyverse：

```{r eval=FALSE}
require(tidyverse)
```

**以后每次跟着本书使用R的时候，都要先加载tidyverse，不再重复提醒了。**

tidyverse中自带一些范例数据，比如我们输入：

```{r eval=FALSE}
mpg
```

```{r echo=FALSE}
knitr::include_graphics('img/tibble-intro.png')
```

这张图是重中之重。一个正确的dataframe/tibble，每一行代表的是一个observation（硬翻译的话是“观测单位”，但是我觉得这个翻译不好），每一列代表的是一个variable（变量），且同一个变量的数据类型必须一样[^1]。像这样的数据被称为“tidy data”（“整齐的数据”）。虽然看起来简单，直观，理所当然，但是现实中上人们经常会做出“不整齐”的数据。把不整齐的数据弄整齐是下一章的重点。

### 查看更多数据 {#tibble-more-data}

R默认显示dataframe/tibble的前10行。如果想看最后6行，可以使用`tail()`函数，比如：

```{r}
tail(mpg)
```

若要从头到尾查看全部数据，可以使用`View`函数：

```{r eval=FALSE}
View(mpg)
```

## tibble的创建和基础操作 {#tibble-basics}

### 创建tibble {#tibble-create}

#### 手动输入数据以创建tibble {#tibble-create-manual}

使用`tibble`函数，按以下格式创建tibble. 换行不是必须的，但是换行会看得更清楚。如果换行，不要忘记行末的逗号。

```{r}
my_tibble_1 <- tibble(
                nums = c(4, 5, 6),
                chars = c("hej", "你好", "こんにちは"),
                cplxnums = c("4+8i", "3+5i", "3+4i")
                )
my_tibble_1
```

类似地，可以从现有的vector创建。**所有的变量长度必须一样。**

```{r}
x <- c(1,4,5)
y <- c(211,23,45)
z <- c(20,32)
```

```{r}
my_tibble_2 <- tibble(v1 = x, v2 = y)
my_tibble_2
```

而试图把`x`和`z`做成tibble就会报错：

```{r eval=FALSE}
my_tibble_3 <- tibble(w1 = x, w2 = z)

 # Error: Tibble columns must have consistent lengths, only values of length one are recycled: * Length 2: Column `w2` * Length 3: Column `w1`
```

#### 把dataframe转换成一个tibble {#tibble-create-from-df}

```{r eval=FALSE}
d1 <- as.tibble(d) #其中d是一个dataframe
```

#### 从外部数据创建tibble {#tibble-import}

参见第\@ref(data-import)节（数据的导入）



### 取子集（抓取行，列）{tbl-subsetting}

本节介绍了如何使用`dplyr` package提供的`select()`, `filter()`, `slice`取子集方法
更详细的解释请看第\@ref(tbl-subsetting-more)节。

#### 抓取单列 {#single-column}

抓取单列很简单，也很常用（比如我们只想从一个大的tibble中抓两个变量研究它们之间的关系）。 有两个符号可以用于抓取列，`$`（仅用于变量名称）与`[[]]`（变量名称或索引）。还是以`mpg`为例，假设我们要抓取第3列 (`displ`)：

```{r eval=FALSE}
########################
#通过变量名称抓取：
mpg[["displ"]]
#或
mpg$displ #一般，在RStudio中此方法最方便，因为打出“$”之后会自动提示变量名。

########################
#通过索引抓取：
mpg[[3]]
```

以上三种方法都应得到同样的结果（是一个vector）：

```{r echo=FALSE}
mpg[[3]][1:20] 
#因为长度有222，为避免浪费空间我们只显示第1到20个元素。顺便复习一下向量的索引。
```

一般我们抓取单列是为了在tibble中新建一个与那一列相关的变量，或是建一个新tibble，或是做统计学分析。以上三种情况（是绝大多数的情况）用vector进行操作很方便。

假设你在写一个复杂的函数，且需要保持数据的完整性和一致性，可以使用单方括号`[`；这样得到的是一个tibble（试试`mpg[3]`）这个特性在第\@ref(tbl-subsetting-more)节中有解释。

#### 抓取多列并返回一个tibble

有时候，一个tibble中含有很多冗余信息，我们可能想把感兴趣的几个变量抓出来做一个新tibble. 这时`select()`函数最为方便。可以用变量名称或者索引来抓取。比如：

```{r}
mpg_new <- select(mpg, 3:5, 8, 9)
#等同于
mpg_new <- select(mpg, displ, year, cyl, cty, hwy)

mpg_new
```

显然，使用变量名抓取列比使用索引更好。虽然打字较多，但是易读性比使用索引强太多了。在向其他人展示或者分享你的工作时，易读性尤为重要。

#### 通过`filter()`，抓取满足某条件的行

通过`filter()`，我们可以过滤出某个或多个变量满足某种条件的observations. 如果你还不熟悉逻辑运算，请看第\@ref(logical-operations)节

假设我们只想看`mpg`中的奥迪品牌的，排量大于等于2且小于4的车辆的数据：

```{r}
mpg_audi_displ2to4 <- filter(mpg, manufacturer == "audi", displ >= 2.5 & displ < 4)

mpg_audi_displ2to4
```

#### 用`slice()`，通过行数（索引）抓取行。

```{r}
mpg_1to6 <- slice(mpg, 21:26) # 抓取mpg的第21行至26行
mpg_1to6
```

`slice()`更实际的用途是随机选择个体：

```{r}
mpg_random4 <- slice(mpg, sample(length(mpg[[1]]), 4)) # 随机四辆车
mpg_random4
```

## 其它 {#tibble-misc}

### list和dataframe/tibble

#### Dataframe和tibble的本质

聪明的你也许已经注意到了，dataframe/tibble[抓取单列的方法](#single-column)和list的取子集\@ref(list-index)惊人地相似。事实上，dataframe的本质正是list，而tibble也是dataframe（只是进化了一些功能）：

```{r}
is.list(mpg)
class(mpg)
```

#### Dataframe/tibble的取子集 {#tbl-subsetting-more}

Tibble既有list的特征，也有matrix的特征。

当使用一个参数取子集的时候，比如`mpg[[3]]`，`mpg[["displ"]]`或`mpg$displ`，tibble表现得像list，其中每一列是一个有命名的list element；

当使用两个参数取子集的时候，比如`mpg[3,4]`, `mpg[3, ]`, `mpg[ ,4]`，tibble表现得像matrix

```{r}
mpg[3, ]
```

### Base R dataframe 和 Tidyverse tibble的区别 {#tibble-df-diff}

你可能已经注意到，上面`mpg[3, ]`和`select(mpg, 3)`是等效的；`mpg[3, ]`显然更精简，那么为什么要使用`select()`函数呢？

```{r eval=FALSE}
sapply(MyDF, class)
dim(MyDF)
```


zaocheng[@Gentleman2009R-Programming-Bioinfo, p. 33; @Wickham:2019]

请查看[Advanced R](https://adv-r.hadley.nz/subsetting.html#simplify-preserve)了解更多。
